version: "1.0"
fail_fast: true
stages:
  - prepare
  - release

steps:
  fetch_gpg_key:
    stage: prepare
    title: Fetch GPG key
    image: codefresh/cli
    commands:
      - mkdir -p "${CF_VOLUME_PATH}/keys"
      - codefresh get context terraform-provider-gpg --output=json --decrypt | jq -re '.spec.data.key' > "${CF_VOLUME_PATH}/keys/terraform-provider.gpg"

  clone:
    stage: prepare
    title: Clone
    type: git-clone
    repo: ${{CF_REPO_OWNER}}/${{CF_REPO_NAME}}
    revision: ${{CF_REVISION}}
    git: github

  build_shell:
    stage: prepare
    title: Build shell
    type: build
    working_directory: "${{clone}}/pipeline"
    registry: utility
    image_name: ${{CF_REPO_OWNER}}/${{CF_REPO_NAME}}
    tag: ${{CF_BUILD_ID}}
    disable_push: true

  build:
    stage: release
    title: Build
    image: "${{build_shell}}"
    working_directory: "${{clone}}"
    commands:
      - gpg --import "${CF_VOLUME_PATH}/keys/terraform-provider.gpg"
      - make crossbuild
